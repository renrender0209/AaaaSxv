{% extends "base.html" %}

{% block content %}
<div class="spotify-app">
    <!-- サイドバー -->
    <div class="spotify-sidebar">
        <div class="sidebar-header">
            <div class="logo">
                <i class="fab fa-spotify"></i>
                <span>Music</span>
            </div>
        </div>
        
        <nav class="sidebar-nav">
            <ul>
                <li class="nav-item active" data-tab="home">
                    <i class="fas fa-home"></i>
                    <span>ホーム</span>
                </li>
                <li class="nav-item" data-tab="search">
                    <i class="fas fa-search"></i>
                    <span>検索</span>
                </li>
                <li class="nav-item" data-tab="library">
                    <i class="fas fa-book"></i>
                    <span>ライブラリ</span>
                </li>
            </ul>
            
            <div class="playlist-section">
                <div class="create-playlist">
                    <i class="fas fa-plus"></i>
                    <span>プレイリストを作成</span>
                </div>
                <div class="liked-songs">
                    <i class="fas fa-heart"></i>
                    <span>お気に入りの曲</span>
                </div>
            </div>
        </nav>
    </div>
        
    <!-- メインコンテンツ -->
    <div class="spotify-main">
        <div class="main-header">
            <div class="navigation-buttons">
                <button class="nav-btn" onclick="history.back()">
                    <i class="fas fa-chevron-left"></i>
                </button>
                <button class="nav-btn" onclick="history.forward()">
                    <i class="fas fa-chevron-right"></i>
                </button>
            </div>
        </div>
        
        <div class="main-content">
            <!-- ホーム画面 -->
            <div class="content-section active" id="homeSection">
                <div class="section-header">
                    <h1>今日の気分</h1>
                </div>
                
                <!-- クイックピック -->
                <div class="quick-picks">
                    <div class="pick-item" onclick="playRandomMusic('j-pop')">
                        <img src="https://via.placeholder.com/150x150/1db954/ffffff?text=J-POP" alt="J-POP">
                        <span>J-POP ヒッツ</span>
                    </div>
                    <div class="pick-item" onclick="playRandomMusic('rock')">
                        <img src="https://via.placeholder.com/150x150/ff6b6b/ffffff?text=ROCK" alt="Rock">
                        <span>ロック クラシック</span>
                    </div>
                    <div class="pick-item" onclick="playRandomMusic('pop')">
                        <img src="https://via.placeholder.com/150x150/4ecdc4/ffffff?text=POP" alt="Pop">
                        <span>ポップ ミュージック</span>
                    </div>
                    <div class="pick-item" onclick="playRandomMusic('anime')">
                        <img src="https://via.placeholder.com/150x150/45b7d1/ffffff?text=ANIME" alt="Anime">
                        <span>アニメソング</span>
                    </div>
                </div>
                
                <!-- トレンド音楽 -->
                <div class="section-header">
                    <h2>トレンド音楽</h2>
                    <button class="show-all-btn">すべて表示</button>
                </div>
                
                <div class="music-grid" id="trendingMusicGrid">
                    {% for track in trending_music %}
                    <div class="music-card" data-video-id="{{ track.id }}" onclick="playMusic('{{ track.id }}', '{{ track.title|e }}', '{{ track.artist|e }}')">
                        <div class="card-image">
                            {% if track.thumbnail %}
                            <img src="{{ track.thumbnail }}" alt="{{ track.title }}">
                            {% else %}
                            <div class="placeholder-image">
                                <i class="fas fa-music"></i>
                            </div>
                            {% endif %}
                            <div class="play-button">
                                <i class="fas fa-play"></i>
                            </div>
                        </div>
                        <div class="card-content">
                            <h3 class="track-title">{{ track.title }}</h3>
                            <p class="track-artist">{{ track.artist }}</p>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            
            <!-- 検索画面 -->
            <div class="content-section" id="searchSection">
                <div class="search-container">
                    <div class="search-input-container">
                        <i class="fas fa-search search-icon"></i>
                        <input type="text" id="musicSearchInput" placeholder="アーティスト、楽曲、プレイリストを検索" onkeypress="handleSearchKeypress(event)">
                    </div>
                </div>
                
                <div class="search-results" id="searchResults">
                    <!-- 検索結果がここに表示される -->
                </div>
            </div>
            
            <!-- ライブラリ画面 -->
            <div class="content-section" id="librarySection">
                <div class="section-header">
                    <h1>あなたのライブラリ</h1>
                </div>
                
                <div class="library-filters">
                    <button class="filter-btn active">最近再生した楽曲</button>
                    <button class="filter-btn">アーティスト</button>
                    <button class="filter-btn">アルバム</button>
                </div>
                
                <div class="library-content" id="libraryContent">
                    <!-- ライブラリコンテンツがここに表示される -->
                </div>
            </div>
        </div>
    </div>
    <!-- 音楽プレイヤー（下部固定） -->
    <div class="spotify-player" id="spotifyPlayer">
        <div class="player-left">
            <div class="current-track-image">
                <img id="currentTrackImage" src="https://via.placeholder.com/56x56/333/fff?text=♪" alt="Current Track">
            </div>
            <div class="current-track-info">
                <div class="track-name" id="currentTrackName">楽曲を選択してください</div>
                <div class="artist-name" id="currentArtistName">アーティスト</div>
            </div>
            <button class="like-btn" id="likeBtn">
                <i class="far fa-heart"></i>
            </button>
        </div>
        
        <div class="player-center">
            <div class="player-controls">
                <button class="control-btn" id="shuffleBtn">
                    <i class="fas fa-random"></i>
                </button>
                <button class="control-btn" id="prevBtn">
                    <i class="fas fa-step-backward"></i>
                </button>
                <button class="play-btn" id="playBtn">
                    <i class="fas fa-play"></i>
                </button>
                <button class="control-btn" id="nextBtn">
                    <i class="fas fa-step-forward"></i>
                </button>
                <button class="control-btn" id="repeatBtn">
                    <i class="fas fa-redo"></i>
                </button>
            </div>
            <div class="progress-container">
                <span class="time" id="currentTime">0:00</span>
                <div class="progress-bar">
                    <div class="progress-bg">
                        <div class="progress-fill" id="progressFill"></div>
                        <div class="progress-handle" id="progressHandle"></div>
                    </div>
                </div>
                <span class="time" id="totalTime">0:00</span>
            </div>
        </div>
        
        <div class="player-right">
            <button class="control-btn" id="queueBtn">
                <i class="fas fa-list"></i>
            </button>
            <button class="control-btn" id="deviceBtn">
                <i class="fas fa-desktop"></i>
            </button>
            <div class="volume-container">
                <button class="control-btn" id="volumeBtn">
                    <i class="fas fa-volume-up"></i>
                </button>
                <div class="volume-bar">
                    <div class="volume-bg">
                        <div class="volume-fill" id="volumeFill"></div>
                        <div class="volume-handle" id="volumeHandle"></div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 音声要素 -->
        <audio id="audioPlayer" preload="metadata"></audio>
    </div>
</div>
<style>
/* Spotify風のダークテーマ */
.spotify-app {
    display: flex;
    height: calc(100vh - 56px);
    background: #000;
    color: #fff;
    font-family: 'Helvetica Neue', Arial, sans-serif;
}

.spotify-sidebar {
    width: 240px;
    background: #000;
    padding: 24px 12px 0;
    display: flex;
    flex-direction: column;
}

.sidebar-header .logo {
    display: flex;
    align-items: center;
    font-size: 24px;
    font-weight: bold;
    margin-bottom: 24px;
    padding: 0 12px;
}

.sidebar-header .logo i {
    color: #1db954;
    margin-right: 8px;
}

.sidebar-nav ul {
    list-style: none;
    padding: 0;
    margin: 0;
}

.nav-item {
    display: flex;
    align-items: center;
    padding: 12px;
    color: #b3b3b3;
    cursor: pointer;
    border-radius: 4px;
    transition: all 0.2s;
    margin-bottom: 8px;
}

.nav-item:hover {
    color: #fff;
    background: #1a1a1a;
}

.nav-item.active {
    color: #fff;
    background: #1a1a1a;
}

.nav-item i {
    width: 24px;
    margin-right: 16px;
    font-size: 20px;
}

.playlist-section {
    margin-top: 24px;
    padding-top: 16px;
    border-top: 1px solid #282828;
}

.create-playlist, .liked-songs {
    display: flex;
    align-items: center;
    padding: 8px 12px;
    color: #b3b3b3;
    cursor: pointer;
    border-radius: 4px;
    transition: all 0.2s;
    margin-bottom: 8px;
}

.create-playlist:hover, .liked-songs:hover {
    color: #fff;
    background: #1a1a1a;
}

.create-playlist i, .liked-songs i {
    width: 24px;
    margin-right: 16px;
    font-size: 20px;
}

.spotify-main {
    flex: 1;
    background: linear-gradient(180deg, #1a1a1a 0%, #121212 100%);
    overflow-y: auto;
    padding-bottom: 90px;
}

.main-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 16px 32px;
    background: rgba(0,0,0,0.6);
    backdrop-filter: blur(10px);
    position: sticky;
    top: 0;
    z-index: 10;
}

.navigation-buttons {
    display: flex;
    gap: 16px;
}

.nav-btn {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    background: rgba(0,0,0,0.7);
    border: none;
    color: #fff;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s;
}

.nav-btn:hover {
    background: rgba(255,255,255,0.1);
    transform: scale(1.04);
}

.main-content {
    padding: 0 32px;
}

.content-section {
    display: none;
}

.content-section.active {
    display: block;
}

.section-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin: 32px 0 24px;
}

.section-header h1 {
    font-size: 32px;
    font-weight: 900;
    margin: 0;
}

.section-header h2 {
    font-size: 24px;
    font-weight: 700;
    margin: 0;
}

.show-all-btn {
    background: none;
    border: none;
    color: #b3b3b3;
    font-size: 14px;
    font-weight: 700;
    cursor: pointer;
    text-decoration: underline;
}

.show-all-btn:hover {
    color: #fff;
}

.quick-picks {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 16px;
    margin-bottom: 48px;
}

.pick-item {
    display: flex;
    align-items: center;
    background: #282828;
    border-radius: 4px;
    overflow: hidden;
    cursor: pointer;
    transition: all 0.2s;
}

.pick-item:hover {
    background: #3e3e3e;
    transform: scale(1.02);
}

.pick-item img {
    width: 80px;
    height: 80px;
    object-fit: cover;
}

.pick-item span {
    padding: 0 16px;
    font-weight: 700;
    font-size: 16px;
}

.music-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
    gap: 24px;
    margin-bottom: 48px;
}

.music-card {
    background: #181818;
    border-radius: 8px;
    padding: 16px;
    cursor: pointer;
    transition: all 0.3s;
    position: relative;
}

.music-card:hover {
    background: #282828;
    transform: translateY(-4px);
}

.card-image {
    position: relative;
    margin-bottom: 16px;
    border-radius: 8px;
    overflow: hidden;
}

.card-image img {
    width: 100%;
    aspect-ratio: 1;
    object-fit: cover;
}

.placeholder-image {
    width: 100%;
    aspect-ratio: 1;
    background: #282828;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 48px;
    color: #535353;
}

.play-button {
    position: absolute;
    bottom: 8px;
    right: 8px;
    width: 48px;
    height: 48px;
    background: #1db954;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #000;
    font-size: 16px;
    opacity: 0;
    transform: translateY(8px);
    transition: all 0.3s;
    box-shadow: 0 8px 24px rgba(0,0,0,0.5);
}

.music-card:hover .play-button {
    opacity: 1;
    transform: translateY(0);
}

.track-title {
    font-size: 16px;
    font-weight: 700;
    margin: 0 0 4px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}

.track-artist {
    font-size: 14px;
    color: #b3b3b3;
    margin: 0;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}

.search-container {
    max-width: 364px;
    margin-bottom: 32px;
}

.search-input-container {
    position: relative;
    display: flex;
    align-items: center;
}

.search-icon {
    position: absolute;
    left: 12px;
    color: #b3b3b3;
    z-index: 1;
}

.search-input-container input {
    width: 100%;
    height: 48px;
    background: #242424;
    border: none;
    border-radius: 24px;
    color: #fff;
    font-size: 14px;
    padding: 0 16px 0 48px;
    outline: none;
}

.search-input-container input:focus {
    background: #2a2a2a;
    border: 1px solid #535353;
}

.library-filters {
    display: flex;
    gap: 8px;
    margin-bottom: 16px;
}

.filter-btn {
    background: #232323;
    border: none;
    color: #fff;
    padding: 8px 12px;
    border-radius: 20px;
    font-size: 14px;
    cursor: pointer;
    transition: all 0.2s;
}

.filter-btn.active {
    background: #fff;
    color: #000;
}

.filter-btn:hover:not(.active) {
    background: #2a2a2a;
}

/* 音楽プレイヤー */
.spotify-player {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    height: 90px;
    background: #181818;
    border-top: 1px solid #282828;
    display: flex;
    align-items: center;
    padding: 0 16px;
    z-index: 1000;
}

.player-left {
    display: flex;
    align-items: center;
    width: 30%;
    min-width: 180px;
}

.current-track-image {
    width: 56px;
    height: 56px;
    border-radius: 4px;
    overflow: hidden;
    margin-right: 14px;
}

.current-track-image img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.current-track-info {
    flex: 1;
    min-width: 0;
}

.track-name {
    font-size: 14px;
    font-weight: 400;
    color: #fff;
    margin-bottom: 4px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}

.artist-name {
    font-size: 12px;
    color: #b3b3b3;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}

.like-btn {
    background: none;
    border: none;
    color: #b3b3b3;
    font-size: 16px;
    cursor: pointer;
    padding: 8px;
    transition: all 0.2s;
}

.like-btn:hover {
    color: #fff;
    transform: scale(1.04);
}

.player-center {
    display: flex;
    flex-direction: column;
    align-items: center;
    width: 40%;
    max-width: 722px;
}

.player-controls {
    display: flex;
    align-items: center;
    gap: 16px;
    margin-bottom: 8px;
}

.control-btn {
    background: none;
    border: none;
    color: #b3b3b3;
    font-size: 16px;
    cursor: pointer;
    padding: 8px;
    transition: all 0.2s;
}

.control-btn:hover {
    color: #fff;
    transform: scale(1.06);
}

.play-btn {
    width: 32px;
    height: 32px;
    background: #fff;
    border: none;
    border-radius: 50%;
    color: #000;
    font-size: 14px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s;
}

.play-btn:hover {
    transform: scale(1.06);
}

.progress-container {
    display: flex;
    align-items: center;
    width: 100%;
    gap: 8px;
}

.time {
    font-size: 12px;
    color: #b3b3b3;
    min-width: 40px;
    text-align: center;
}

.progress-bar {
    flex: 1;
    height: 4px;
    cursor: pointer;
}

.progress-bg {
    width: 100%;
    height: 4px;
    background: #4f4f4f;
    border-radius: 2px;
    position: relative;
}

.progress-fill {
    height: 100%;
    background: #fff;
    border-radius: 2px;
    width: 0%;
    transition: width 0.1s;
}

.progress-handle {
    width: 12px;
    height: 12px;
    background: #fff;
    border-radius: 50%;
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    left: 0%;
    opacity: 0;
    transition: opacity 0.2s;
}

.progress-bar:hover .progress-handle {
    opacity: 1;
}

.player-right {
    display: flex;
    align-items: center;
    justify-content: flex-end;
    width: 30%;
    min-width: 180px;
    gap: 8px;
}

.volume-container {
    display: flex;
    align-items: center;
    gap: 8px;
}

.volume-bar {
    width: 93px;
    height: 4px;
    cursor: pointer;
}

.volume-bg {
    width: 100%;
    height: 4px;
    background: #4f4f4f;
    border-radius: 2px;
    position: relative;
}

.volume-fill {
    height: 100%;
    background: #fff;
    border-radius: 2px;
    width: 70%;
    transition: width 0.1s;
}

.volume-handle {
    width: 12px;
    height: 12px;
    background: #fff;
    border-radius: 50%;
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    left: 70%;
    opacity: 0;
    transition: opacity 0.2s;
}

.volume-bar:hover .volume-handle {
    opacity: 1;
}

@media (max-width: 768px) {
    .spotify-app {
        flex-direction: column;
    }
    
    .spotify-sidebar {
        width: 100%;
        height: auto;
        flex-direction: row;
        padding: 16px;
    }
    
    .spotify-main {
        padding-bottom: 120px;
    }
    
    .main-content {
        padding: 0 16px;
    }
    
    .music-grid {
        grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
        gap: 16px;
    }
    
    .quick-picks {
        grid-template-columns: 1fr;
    }
    
    .spotify-player {
        height: 120px;
        flex-direction: column;
        padding: 8px 16px;
    }
    
    .player-left, .player-center, .player-right {
        width: 100%;
    }
}
</style>
            
            <!-- 検索結果 -->
            <div class="search-results" id="searchResults" style="display: none;">
                <h4>検索結果</h4>
                <div class="music-list" id="searchList">
                    <!-- 検索結果がここに表示される -->
                </div>
            </div>
            
            <!-- プレイリスト -->
            <div class="playlists-section" id="playlistsSection" style="display: none;">
                <h4>プレイリスト</h4>
                <div class="playlist-creation">
                    <input type="text" id="newPlaylistName" class="form-control" placeholder="新しいプレイリスト名">
                    <button class="btn btn-primary" onclick="createPlaylist()">作成</button>
                </div>
                <div class="playlists-list" id="playlistsList">
                    <!-- プレイリストがここに表示される -->
                </div>
            </div>
        </div>
        
        <!-- 音楽プレイヤー -->
        <div class="col-md-3 music-player-section">
            <div class="music-player" id="musicPlayer">
                <div class="now-playing">
                    <div class="current-track-info">
                        <div class="track-thumbnail">
                            <img id="currentTrackThumb" src="" alt="現在再生中">
                        </div>
                        <div class="track-details">
                            <div class="track-title" id="currentTrackTitle">楽曲を選択してください</div>
                            <div class="track-artist" id="currentTrackArtist"></div>
                        </div>
                    </div>
                    
                    <div class="player-controls">
                        <button class="btn btn-outline-secondary" onclick="previousTrack()">
                            <i class="fas fa-step-backward"></i>
                        </button>
                        <button class="btn btn-primary play-pause-btn" id="playPauseBtn" onclick="togglePlayPause()">
                            <i class="fas fa-play"></i>
                        </button>
                        <button class="btn btn-outline-secondary" onclick="nextTrack()">
                            <i class="fas fa-step-forward"></i>
                        </button>
                    </div>
                    
                    <div class="progress-section">
                        <div class="time-display">
                            <span id="currentTime">0:00</span>
                            <span id="totalTime">0:00</span>
                        </div>
                        <div class="progress-bar">
                            <input type="range" id="progressSlider" min="0" max="100" value="0" onchange="seekTo(this.value)">
                        </div>
                    </div>
                    
                    <div class="volume-section">
                        <i class="fas fa-volume-up"></i>
                        <input type="range" id="volumeSlider" min="0" max="100" value="50" onchange="setVolume(this.value)">
                    </div>
                </div>
                
                <!-- 音声要素 -->
                <audio id="musicAudio" preload="metadata">
                    お使いのブラウザは音楽再生をサポートしていません。
                </audio>
            </div>
            
            <!-- 現在のプレイリスト -->
            <div class="current-playlist">
                <h5>再生リスト</h5>
                <div class="playlist-tracks" id="currentPlaylistTracks">
                    <!-- 現在のプレイリストがここに表示 -->
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.music-app {
    height: calc(100vh - 80px);
    overflow: hidden;
}

.music-sidebar {
    background: #1a1a1a;
    color: white;
    padding: 20px 0;
    height: 100%;
    overflow-y: auto;
}

.sidebar-header {
    padding: 0 20px 20px;
    border-bottom: 1px solid #333;
}

.sidebar-menu {
    padding-top: 20px;
}

.menu-item {
    padding: 15px 20px;
    cursor: pointer;
    transition: background 0.3s;
    border-left: 3px solid transparent;
}

.menu-item:hover {
    background: #333;
}

.menu-item.active {
    background: #007bff;
    border-left-color: #fff;
}

.music-main {
    height: 100%;
    overflow-y: auto;
    padding: 20px;
    background: #f8f9fa;
}

.search-bar {
    display: flex;
    gap: 10px;
    margin-bottom: 20px;
}

.music-list {
    display: flex;
    flex-direction: column;
    gap: 10px;
}

.music-item {
    display: flex;
    align-items: center;
    background: white;
    border-radius: 8px;
    padding: 15px;
    cursor: pointer;
    transition: all 0.3s;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.music-item:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.15);
}

.music-thumbnail {
    position: relative;
    width: 60px;
    height: 60px;
    border-radius: 8px;
    overflow: hidden;
    margin-right: 15px;
}

.music-thumbnail img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.placeholder-thumb {
    width: 100%;
    height: 100%;
    background: #dee2e6;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 24px;
    color: #6c757d;
}

.play-overlay {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0,0,0,0.7);
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    opacity: 0;
    transition: opacity 0.3s;
}

.music-item:hover .play-overlay {
    opacity: 1;
}

.music-info {
    flex: 1;
}

.music-title {
    font-weight: bold;
    font-size: 16px;
    margin-bottom: 5px;
}

.music-artist {
    color: #6c757d;
    font-size: 14px;
    margin-bottom: 5px;
}

.music-duration {
    color: #6c757d;
    font-size: 12px;
}

.music-player-section {
    background: white;
    border-left: 1px solid #dee2e6;
    height: 100%;
    overflow-y: auto;
}

.music-player {
    padding: 20px;
    border-bottom: 1px solid #dee2e6;
}

.current-track-info {
    text-align: center;
    margin-bottom: 20px;
}

.track-thumbnail {
    width: 150px;
    height: 150px;
    margin: 0 auto 15px;
    border-radius: 8px;
    overflow: hidden;
    background: #dee2e6;
}

.track-thumbnail img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.track-title {
    font-weight: bold;
    font-size: 18px;
    margin-bottom: 5px;
}

.track-artist {
    color: #6c757d;
    font-size: 14px;
}

.player-controls {
    display: flex;
    justify-content: center;
    gap: 10px;
    margin-bottom: 20px;
}

.play-pause-btn {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
}

.progress-section {
    margin-bottom: 15px;
}

.time-display {
    display: flex;
    justify-content: space-between;
    font-size: 12px;
    color: #6c757d;
    margin-bottom: 5px;
}

.progress-bar input[type="range"] {
    width: 100%;
}

.volume-section {
    display: flex;
    align-items: center;
    gap: 10px;
}

.volume-section input[type="range"] {
    flex: 1;
}

.current-playlist {
    padding: 20px;
}

.playlist-tracks {
    max-height: 300px;
    overflow-y: auto;
}

.playlist-creation {
    display: flex;
    gap: 10px;
    margin-bottom: 20px;
}

@media (max-width: 768px) {
    .music-app .row {
        flex-direction: column;
    }
    
    .music-sidebar {
        height: auto;
        order: 3;
    }
    
    .music-main {
        order: 1;
        height: auto;
    }
    
    .music-player-section {
        order: 2;
        height: auto;
        border-left: none;
        border-top: 1px solid #dee2e6;
    }
}
</style>

<script>
let currentTrack = null;
let isPlaying = false;
let currentPlaylist = [];
let currentTrackIndex = -1;

// ページ読み込み時の初期化
document.addEventListener('DOMContentLoaded', function() {
    // メニュー切り替え
    document.querySelectorAll('.menu-item').forEach(item => {
        item.addEventListener('click', function() {
            const tab = this.dataset.tab;
            switchTab(tab);
        });
    });
    
    // 音楽プレイヤーの初期化
    initializeMusicPlayer();
});

function switchTab(tab) {
    // メニューのアクティブ状態を更新
    document.querySelectorAll('.menu-item').forEach(item => {
        item.classList.remove('active');
    });
    document.querySelector(`[data-tab="${tab}"]`).classList.add('active');
    
    // コンテンツセクションの表示切り替え
    document.getElementById('trendingSection').style.display = tab === 'trending' ? 'block' : 'none';
    document.getElementById('searchSection').style.display = tab === 'search' ? 'block' : 'none';
    document.getElementById('searchResults').style.display = 'none';
    document.getElementById('playlistsSection').style.display = tab === 'playlists' ? 'block' : 'none';
}

function searchMusic() {
    const query = document.getElementById('musicSearchInput').value.trim();
    if (!query) return;
    
    // 検索実行
    fetch(`/api/music/search?q=${encodeURIComponent(query)}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                displaySearchResults(data.results);
            } else {
                console.error('検索エラー:', data.error);
            }
        })
        .catch(error => {
            console.error('検索リクエストエラー:', error);
        });
}

function displaySearchResults(results) {
    const searchList = document.getElementById('searchList');
    searchList.innerHTML = '';
    
    results.forEach(track => {
        const trackElement = createTrackElement(track);
        searchList.appendChild(trackElement);
    });
    
    document.getElementById('searchResults').style.display = 'block';
}

function createTrackElement(track) {
    const trackDiv = document.createElement('div');
    trackDiv.className = 'music-item';
    trackDiv.dataset.videoId = track.id;
    trackDiv.onclick = () => playMusic(track.id, track.title, track.artist);
    
    trackDiv.innerHTML = `
        <div class="music-thumbnail">
            ${track.thumbnail ? 
                `<img src="${track.thumbnail}" alt="${track.title}">` :
                `<div class="placeholder-thumb"><i class="fas fa-music"></i></div>`
            }
            <div class="play-overlay">
                <i class="fas fa-play"></i>
            </div>
        </div>
        <div class="music-info">
            <div class="music-title">${track.title}</div>
            <div class="music-artist">${track.artist}</div>
            <div class="music-duration">${formatDuration(track.duration)}</div>
        </div>
        <div class="music-actions">
            <button class="btn btn-sm btn-outline-primary" onclick="event.stopPropagation(); addToPlaylist('${track.id}')">
                <i class="fas fa-plus"></i>
            </button>
        </div>
    `;
    
    return trackDiv;
}

function playMusic(videoId, title, artist) {
    // ストリーム取得
    fetch(`/api/music/stream/${videoId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                currentTrack = {
                    id: videoId,
                    title: title,
                    artist: artist,
                    url: data.audio_url || data.video_url
                };
                
                loadAndPlayTrack();
            } else {
                console.error('ストリーム取得エラー:', data.error);
            }
        })
        .catch(error => {
            console.error('ストリームリクエストエラー:', error);
        });
}

function loadAndPlayTrack() {
    if (!currentTrack) return;
    
    const audio = document.getElementById('musicAudio');
    audio.src = currentTrack.url;
    
    // UI更新
    document.getElementById('currentTrackTitle').textContent = currentTrack.title;
    document.getElementById('currentTrackArtist').textContent = currentTrack.artist;
    
    // 再生
    audio.play().then(() => {
        isPlaying = true;
        updatePlayPauseButton();
    }).catch(error => {
        console.error('再生エラー:', error);
    });
}

function togglePlayPause() {
    const audio = document.getElementById('musicAudio');
    
    if (isPlaying) {
        audio.pause();
        isPlaying = false;
    } else {
        audio.play().then(() => {
            isPlaying = true;
        }).catch(error => {
            console.error('再生エラー:', error);
        });
    }
    
    updatePlayPauseButton();
}

function updatePlayPauseButton() {
    const btn = document.getElementById('playPauseBtn');
    const icon = btn.querySelector('i');
    
    if (isPlaying) {
        icon.className = 'fas fa-pause';
    } else {
        icon.className = 'fas fa-play';
    }
}

function initializeMusicPlayer() {
    const audio = document.getElementById('musicAudio');
    
    // 音声イベントリスナー
    audio.addEventListener('timeupdate', updateProgress);
    audio.addEventListener('loadedmetadata', updateDuration);
    audio.addEventListener('ended', nextTrack);
    
    // 音量設定
    audio.volume = 0.5;
}

function updateProgress() {
    const audio = document.getElementById('musicAudio');
    const progress = document.getElementById('progressSlider');
    const currentTimeSpan = document.getElementById('currentTime');
    
    if (audio.duration) {
        progress.value = (audio.currentTime / audio.duration) * 100;
        currentTimeSpan.textContent = formatTime(audio.currentTime);
    }
}

function updateDuration() {
    const audio = document.getElementById('musicAudio');
    const totalTimeSpan = document.getElementById('totalTime');
    
    if (audio.duration) {
        totalTimeSpan.textContent = formatTime(audio.duration);
    }
}

function seekTo(percentage) {
    const audio = document.getElementById('musicAudio');
    if (audio.duration) {
        audio.currentTime = (percentage / 100) * audio.duration;
    }
}

function setVolume(volume) {
    const audio = document.getElementById('musicAudio');
    audio.volume = volume / 100;
}

function nextTrack() {
    // プレイリスト機能の実装
    console.log('Next track');
}

function previousTrack() {
    // プレイリスト機能の実装
    console.log('Previous track');
}

function addToPlaylist(videoId) {
    // プレイリスト追加機能の実装
    console.log('Add to playlist:', videoId);
}

function createPlaylist() {
    const name = document.getElementById('newPlaylistName').value.trim();
    if (!name) return;
    
    // プレイリスト作成機能の実装
    console.log('Create playlist:', name);
}

function formatTime(seconds) {
    const minutes = Math.floor(seconds / 60);
    const remainingSeconds = Math.floor(seconds % 60);
    return `${minutes}:${remainingSeconds.toString().padStart(2, '0')}`;
}

function formatDuration(seconds) {
    if (!seconds) return '不明';
    return formatTime(seconds);
}

// JavaScript機能の実装
let currentTrack = null;
let isPlaying = false;
let currentPlaylist = [];
let audio = null;

// ページ読み込み時の初期化
document.addEventListener('DOMContentLoaded', function() {
    audio = document.getElementById('audioPlayer');
    initializePlayer();
    setupNavigation();
});

function initializePlayer() {
    if (!audio) return;
    
    // 音声イベントリスナー
    audio.addEventListener('timeupdate', updateProgress);
    audio.addEventListener('loadedmetadata', updateDuration);
    audio.addEventListener('ended', nextTrack);
    audio.addEventListener('play', () => {
        isPlaying = true;
        updatePlayButton();
    });
    audio.addEventListener('pause', () => {
        isPlaying = false;
        updatePlayButton();
    });
    
    // プレイヤーコントロール
    document.getElementById('playBtn').addEventListener('click', togglePlayPause);
    document.getElementById('nextBtn').addEventListener('click', nextTrack);
    document.getElementById('prevBtn').addEventListener('click', previousTrack);
    
    // 音量設定
    audio.volume = 0.7;
    updateVolumeDisplay();
}

function setupNavigation() {
    document.querySelectorAll('.nav-item').forEach(item => {
        item.addEventListener('click', function() {
            const tab = this.dataset.tab;
            switchTab(tab);
        });
    });
}

function switchTab(tab) {
    // ナビゲーション更新
    document.querySelectorAll('.nav-item').forEach(item => {
        item.classList.remove('active');
    });
    document.querySelector(`[data-tab="${tab}"]`).classList.add('active');
    
    // コンテンツ表示切り替え
    document.querySelectorAll('.content-section').forEach(section => {
        section.classList.remove('active');
    });
    document.getElementById(tab + 'Section').classList.add('active');
}

function handleSearchKeypress(event) {
    if (event.key === 'Enter') {
        searchMusic();
    }
}

function searchMusic() {
    const query = document.getElementById('musicSearchInput').value.trim();
    if (!query) return;
    
    fetch(`/api/music/search?q=${encodeURIComponent(query)}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                displaySearchResults(data.results);
            } else {
                console.error('検索エラー:', data.error);
                showMessage('検索に失敗しました: ' + data.error);
            }
        })
        .catch(error => {
            console.error('検索リクエストエラー:', error);
            showMessage('検索中にエラーが発生しました');
        });
}

function displaySearchResults(results) {
    const searchResults = document.getElementById('searchResults');
    searchResults.innerHTML = '';
    
    if (results.length === 0) {
        searchResults.innerHTML = '<div class="no-results">検索結果が見つかりませんでした</div>';
        return;
    }
    
    const grid = document.createElement('div');
    grid.className = 'music-grid';
    
    results.forEach(track => {
        const card = createMusicCard(track);
        grid.appendChild(card);
    });
    
    searchResults.appendChild(grid);
}

function createMusicCard(track) {
    const card = document.createElement('div');
    card.className = 'music-card';
    card.onclick = () => playMusic(track.id, track.title, track.artist, track.thumbnail);
    
    card.innerHTML = `
        <div class="card-image">
            ${track.thumbnail ? 
                `<img src="${track.thumbnail}" alt="${track.title}">` :
                `<div class="placeholder-image"><i class="fas fa-music"></i></div>`
            }
            <div class="play-button">
                <i class="fas fa-play"></i>
            </div>
        </div>
        <div class="card-content">
            <h3 class="track-title">${track.title}</h3>
            <p class="track-artist">${track.artist}</p>
        </div>
    `;
    
    return card;
}

function playMusic(videoId, title, artist, thumbnail) {
    // ストリーム取得
    fetch(`/api/music/stream/${videoId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                currentTrack = {
                    id: videoId,
                    title: title,
                    artist: artist,
                    thumbnail: thumbnail,
                    url: data.audio_url || data.video_url || data.stream_url
                };
                
                loadAndPlayTrack();
            } else {
                console.error('ストリーム取得エラー:', data.error);
                showMessage('楽曲の再生に失敗しました');
            }
        })
        .catch(error => {
            console.error('ストリームリクエストエラー:', error);
            showMessage('楽曲の読み込み中にエラーが発生しました');
        });
}

function loadAndPlayTrack() {
    if (!currentTrack || !audio) return;
    
    audio.src = currentTrack.url;
    
    // UI更新
    document.getElementById('currentTrackName').textContent = currentTrack.title;
    document.getElementById('currentArtistName').textContent = currentTrack.artist;
    
    if (currentTrack.thumbnail) {
        document.getElementById('currentTrackImage').src = currentTrack.thumbnail;
    }
    
    // 再生
    audio.play().then(() => {
        isPlaying = true;
        updatePlayButton();
    }).catch(error => {
        console.error('再生エラー:', error);
        showMessage('楽曲の再生に失敗しました');
    });
}

function togglePlayPause() {
    if (!audio || !currentTrack) return;
    
    if (isPlaying) {
        audio.pause();
    } else {
        audio.play().catch(error => {
            console.error('再生エラー:', error);
            showMessage('楽曲の再生に失敗しました');
        });
    }
}

function updatePlayButton() {
    const playBtn = document.getElementById('playBtn');
    const icon = playBtn.querySelector('i');
    
    if (isPlaying) {
        icon.className = 'fas fa-pause';
    } else {
        icon.className = 'fas fa-play';
    }
}

function updateProgress() {
    if (!audio || !audio.duration) return;
    
    const progress = (audio.currentTime / audio.duration) * 100;
    document.getElementById('progressFill').style.width = progress + '%';
    document.getElementById('progressHandle').style.left = progress + '%';
    
    document.getElementById('currentTime').textContent = formatTime(audio.currentTime);
}

function updateDuration() {
    if (!audio || !audio.duration) return;
    
    document.getElementById('totalTime').textContent = formatTime(audio.duration);
}

function updateVolumeDisplay() {
    if (!audio) return;
    
    const volume = audio.volume * 100;
    document.getElementById('volumeFill').style.width = volume + '%';
    document.getElementById('volumeHandle').style.left = volume + '%';
}

function nextTrack() {
    // プレイリスト機能の実装
    console.log('Next track functionality');
}

function previousTrack() {
    // プレイリスト機能の実装
    console.log('Previous track functionality');
}

function playRandomMusic(genre) {
    // ジャンル別再生機能
    searchMusic();
    const input = document.getElementById('musicSearchInput');
    input.value = genre;
    searchMusic();
}

function formatTime(seconds) {
    if (!seconds || isNaN(seconds)) return '0:00';
    
    const minutes = Math.floor(seconds / 60);
    const remainingSeconds = Math.floor(seconds % 60);
    return `${minutes}:${remainingSeconds.toString().padStart(2, '0')}`;
}

function showMessage(message) {
    // 簡単なメッセージ表示
    const toast = document.createElement('div');
    toast.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: #1db954;
        color: white;
        padding: 12px 24px;
        border-radius: 4px;
        z-index: 10000;
        font-size: 14px;
    `;
    toast.textContent = message;
    document.body.appendChild(toast);
    
    setTimeout(() => {
        document.body.removeChild(toast);
    }, 3000);
}
</script>
{% endblock %}